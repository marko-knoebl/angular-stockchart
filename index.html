<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Stock Chart</title>

  <!--material CSS-->
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/0.11.2/angular-material.min.css">
  <!--material icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <!-- angular, angular material js-->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular-animate.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular-aria.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-messages.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angular_material/0.11.2/angular-material.min.js"></script>
  <!--jQuery-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <!--D3 & linechart-->
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="line-chart.min.js"></script>
  <!--controllers-->
  <script src="controllers.js"></script>
</head>
<body ng-app="stockChartApp" id="main">

  <div ng-controller="StockChartCtrl as stockChartCtrl">
    <md-content layout="column">
      <md-content layout="row" layout-sm="column">
        <md-input-container style="padding-bottom:2px">
          <label>Stock Symbol</label>
          <input type="text" id="symbolInput" ng-model="symbol" ng-model-options="{updateOn: 'blur'}" ng-change="symbolChange()">
        </md-input-container>
        <md-menu style="padding-bottom:2px; padding-top:2px">
          <md-button ng-model="dateRange" ng-click="stockChartCtrl.openMenu($mdOpenMenu, $event)">
            {{timeframe}}<md-icon md-font-library="material-icons">arrow_drop_down</md-icon>
          </md-button>
          <md-menu-content width="3">
            <md-menu-item ng-repeat="tf in ['1 Month', '2 Months', '3 Months', '6 Months', '10 Months']">
              <md-button ng-click="$parent.$parent.timeframe = tf">
                {{tf}}
              </md-button>
            </md-menu-item>
          </md-menu-content>
        </md-menu>
      </md-content>
      <md-content layout="row">
        <div ng-controller="InnerChartCtrl">
          <linechart data="dataForChart" options="chartOptions"></linechart>
        </div>
      </md-content>
    </md-content>
  </div>

  <script>

    var quoteStorage = {};

    var updateStoredClosePrices = function(symbol, startDate, endDate, callback) {
      // update the corresponding entry in quoteStorage (for the last 10 months);
      // then, call the callback
      // TODO: branch here
      if (!(symbol in quoteStorage) || true) {
        // not stored yet

        var startDate = new Date();
        startDate.setMonth(startDate.getMonth() - 10);
        if (startDate.getMonth() < 0) {
          startDate.setMonth(startDate.getMonth() + 12);
          startDate.setYear(startDate.getYear() - 1);
        }
        var endDate = new Date();
        
        var queryString = 'select * from yahoo.finance.historicaldata where symbol = "' + symbol +
          '" and startDate = "' + startDate.toISOString().slice(0, 10) +
          '" and endDate = "' + endDate.toISOString().slice(0, 10) + '"';
        var queryUrl = 'https://query.yahooapis.com/v1/public/yql?q=' + queryString +
          '&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callaback=';
        $.ajax(queryUrl).done(function(data) {
          if (!data.query.results) {
            showErrorMessage();
            return;
          }
          // store the retrieved data
          quoteStorage[symbol] = data.query.results.quote;
          callback();
        });
      } else {
        callback();
        return;
      }
    }

    var getClosePrices = function(symbol, startDate, endDate, callback) {
      // get the close prices from the specified date range and pass them to 'callback'
      updateStoredClosePrices(symbol, startDate, endDate, function() {
        var filteredPrices = [];
        var quotes = quoteStorage[symbol];
        for (var i = 0; i < quoteStorage[symbol].length; i ++) {
          if (quoteStorage[symbol][i].Date >= startDate.toISOString().slice(0, 10)) {
            filteredPrices.push(quoteStorage[symbol][i]);
          }
        }
        callback(filteredPrices);
      });
    };

    var updateClosePrices = function() {
      // update displayed prices
      var appElement = document.getElementById('main');
      var $scope = angular.element(appElement).scope();

      // retrieve the stock data and change it in the angular model
      getClosePrices($scope.$$childHead.symbol, $scope.$$childHead.startDate, new Date(), function(quotes) {
        var dataForChart = [];
        quotes.reverse();
        quotes.forEach(function(element, index) {
          dataForChart.push({x: index, y: parseFloat(element.Close)});
        });
        $scope.$apply(function() {
          $scope.$$childHead.dataForChart = dataForChart;
        });
      });
    };

    var showErrorMessage = function() {
      alert('Could not get data from the server: The selected time frame may be too long or too short.')
    };

    // add event listeners
    ['#symbolInput'].forEach(function(element) {
      $(element).on('keypress', function(event) {
        if (event.key === 'Enter') {
          $(element).trigger('blur');
        }
      });
    });

    $(document).ready(updateClosePrices);

  </script>

</body>
</html>
