<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Google Phone Gallery</title>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="controllers.js"></script>
</head>
<body ng-app="stockChartApp" id="main">

  <div ng-controller="StockChartCtrl">
    <ul>
      <li ng-repeat="price in prices | orderBy:'date'">
        {{price.date}}: {{price.close}}
      </li>
    </ul>
  </div>
  <input type="button" id="btn1" value="Update Prices">
  </input>

  <script>

    var updateClosePrices = function() {

      var newClosePrices = [];

      // default date range: 1 month
      var date = new Date();
      var endString = date.toISOString().slice(0,10);
      date.setMonth(date.getMonth() - 1);
      if (date.getMonth() === -1) {
        date.setMonth(11);
        date.setYear(date.getYear() - 1);
      }
      startString = date.toISOString().slice(0,10);

      // build a query string to get stock data from yahoo finance
      var queryString = 'select * from yahoo.finance.historicaldata where symbol = "VXUS" and startDate = "' +
        startString +'" and endDate = "' + endString + '"';
      var queryString = encodeURI(queryString).replace(/=/g, '%3D');
      var queryUrl = 'https://query.yahooapis.com/v1/public/yql?q=' +
        queryString +
        '&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=';

      // retrieve the stock data and change it in the angular model
      $.ajax(queryUrl).done(function(data) {
        data.query.results.quote.forEach(function(element) {
          newClosePrices.push(
            {
              'date': element['Date'],
              'close': element['Close']
            }
          );
        });
        var appElement = document.getElementById('main');
        var $scope = angular.element(appElement).scope();
        $scope.$apply(function() {
          $scope.$$childHead.prices = newClosePrices;
        });
      });
    };

    var btn1 = document.getElementById('btn1');
    btn1.addEventListener('click', function(event) {
      updateClosePrices();
    });

    $(document).ready(updateClosePrices);

  </script>

</body>
</html>
